<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ path }}</title>
  <style>
    body {
      background-color: #0e1117;
      color: #e2e2e2;
      font-family: "Inter", sans-serif;
      margin: 0;
      padding: 0;
    }
    h1 { color:#f5f5f5; font-size:1.3em; margin:0.8em 1em 0.2em 1em; }
    .container { display:flex; flex-direction:column; padding:1em; }
    .schema-box {
      background-color:#111419; border-radius:8px; padding:1em; margin-bottom:1em;
      color:#ccc; font-family:monospace;
    }
    .schema-header { font-weight:bold; font-size:1.1em; color:#7ec0ee; margin-bottom:0.5em; }
    .schema-table { width:100%; border-collapse:collapse; margin-top:0.5em; }
    .schema-table th, .schema-table td { border-bottom:1px solid #2d3440; padding:6px 8px; text-align:left; }
    .schema-table th { color:#aaa; font-weight:normal; }
    .type-str { color:#9cdcfe; } .type-int { color:#b5cea8; } .type-float { color:#dcdcaa; }
    .type-list { color:#c586c0; } .type-dict { color:#4ec9b0; }
    .info-bar { margin:0.5em 1em; color:#999; font-weight:bold; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(340px,1fr)); grid-gap:10px; }
    .card {
      background-color:#191d25; border:1px solid #2d3440; border-radius:10px; padding:10px;
      font-family:monospace; font-size:13px; line-height:1.4em; white-space:pre-wrap; overflow-wrap:anywhere;
    }
    .card:hover { border-color:#3e9ad9; box-shadow:0 0 8px rgba(62,154,217,0.3); }
    .card-id { color:#7ec0ee; font-weight:bold; margin-bottom:6px; }
  </style>
</head>
<body>
  <h1>{{ path }}</h1>

  <div class="container">
    <div class="schema-box" id="schemaBox">
      <div class="schema-header" id="schemaHeader">Schema Summary</div>
      <div id="schemaResult">Analyzing...</div>
    </div>

    <div class="info-bar" id="recordCount">Total records: {{ total }}</div>

    <div class="grid">
      {% for line in lines %}
      <div class="card">
        <div class="card-id">#{{ loop.index0 }}</div>
        <div>{{ line | tojson(indent=2) }}</div>
      </div>
      {% endfor %}
    </div>
  </div>

  <script>
    async function analyzeSchema() {
      const path = decodeURIComponent(window.location.pathname.replace(/^\/view\//, ''));
      const res = await fetch(`/api/schema?name=${encodeURIComponent(path)}`);
      const data = await res.json();
      const div = document.getElementById('schemaResult');
      const header = document.getElementById('recordCount');
      const schemaHeader = document.getElementById('schemaHeader');

      if (data.error) {
        div.innerHTML = `<span style="color:#f55;">${data.error}</span>`;
        return;
      }

      header.textContent = `Total records: ${data.records_scanned}`;
      schemaHeader.innerHTML = `Schema Summary: <span style="color:#d7ba7d;">${data.schema_name}</span>`;

      let table = `<table class="schema-table">
        <tr><th>Key</th><th>Types</th><th>Coverage</th></tr>`;
      data.schema.forEach(s => {
        const typeNames = Object.keys(s.types)
          .map(t => `<span class="type-${t}">${t}</span>`).join(', ');
        table += `<tr><td>${s.key}</td><td>${typeNames}</td><td>${s.coverage}%</td></tr>`;
      });
      table += '</table>';
      div.innerHTML = table;
    }

    window.addEventListener('DOMContentLoaded', analyzeSchema);
  </script>
</body>
</html>
