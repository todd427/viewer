<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ name }}</title>

<!-- Markdown + Syntax highlighting -->
<script src="/static/js/marked.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">

<style>
body { font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background-color: #0e1117; color: #e6edf3; margin: 0; padding: 0; }
header {
  background-color: #161b22; border-bottom: 1px solid #30363d;
  padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center;
}
h1 { margin: 0; font-size: 1rem; color: #79c0ff; }
.container { padding: 1rem 2rem; }
.grid { display: flex; flex-direction: column; gap: 1.2rem; }
.card { background-color: #161b22; border: 1px solid #30363d; border-radius: 12px;
  padding: 1rem 1.25rem; transition: all 0.2s ease; box-shadow: 0 0 6px rgba(0,0,0,0.25); }
.card:nth-child(even) { background-color: #1b1f27; }
.card:hover { border-color: #58a6ff; box-shadow: 0 0 12px rgba(88,166,255,0.3); }
.card-header { font-size: 0.85rem; color: #8b949e; margin-bottom: 0.5rem; }

.role { font-weight: 600; text-transform: uppercase; font-size: 0.75rem;
  letter-spacing: 0.05em; margin: 0.4rem 0; }
.role.user { color: #58a6ff; } .role.assistant { color: #3fb950; } .role.system { color: #f2cc60; }

.message { background-color: #0d1117; border-radius: 8px; padding: 0.75rem;
  line-height: 1.5; word-wrap: break-word; overflow-x: auto; margin-bottom: 0.5rem; }
.message code, pre { background: #1c2128; padding: 0.25rem 0.4rem; border-radius: 6px;
  font-family: "JetBrains Mono", monospace; }
.message p { margin: 0.4rem 0; }

details { background-color: #11151d; border-radius: 8px; margin-top: 0.5rem; padding: 0.5rem 0.75rem; }
summary { color: #58a6ff; cursor: pointer; font-weight: 600; outline: none; }
.pagination { display: flex; justify-content: center; gap: 1rem; padding: 1rem 0; font-size: 0.9rem; color: #8b949e; }
</style>
</head>

<body>
<header>
  <h1>{{ name }}</h1>
  <div class="search-bar">
    <label style="margin-right:6px;">Search:</label>
    <input id="searchInput" type="text" placeholder="text or regex" oninput="applySearch()">
  </div>
</header>

<div class="container">
  <div id="meta" style="margin-bottom:1rem;color:#8b949e;">Loading records…</div>
  <div id="grid" class="grid"></div>
  <div id="pagination" class="pagination"></div>
</div>

<script>
const filePath = "{{ name.lstrip('/') }}"; // correct path

let records = [], filtered = [];
let currentPage = 1;
const pageSize = 10;

marked.setOptions({
  highlight: (code, lang) => {
    try { return hljs.highlight(code, { language: lang }).value; }
    catch { return hljs.highlightAuto(code).value; }
  }
});

async function loadRecords() {
  try {
    const res = await fetch(`/api/read?name=${encodeURIComponent(filePath)}`);
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error("Invalid response format");
    records = data;
    filtered = data;
    document.getElementById("meta").textContent = `Total records: ${records.length}`;
    renderPage();
  } catch (err) {
    document.getElementById("meta").textContent = "Error loading file: " + err.message;
    console.error("Load error:", err);
  }
}

function applySearch() {
  const query = document.getElementById("searchInput").value.trim();
  if (!query) filtered = records;
  else {
    const regex = new RegExp(query, "i");
    filtered = records.filter(r => JSON.stringify(r).match(regex));
  }
  currentPage = 1;
  renderPage();
}

function renderPage() {
  const start = (currentPage - 1) * pageSize;
  const slice = filtered.slice(start, start + pageSize);
  document.getElementById("grid").innerHTML = slice.map((r,i)=>renderCard(r,start+i)).join("");
  document.getElementById("pagination").innerHTML = `
    <button onclick="prevPage()" ${currentPage===1?'disabled':''}>Prev</button>
    Page ${currentPage} / ${Math.ceil(filtered.length/pageSize)}
    <button onclick="nextPage()" ${(start+pageSize)>=filtered.length?'disabled':''}>Next</button>`;
  hljs.highlightAll();
}

function renderCard(record, index) {
  if (record._schema_summary) {
    return `<div class="card" style="background:#202531;border-left:4px solid #58a6ff;">
      <div class="card-header">Schema Summary</div>
      <div class="message">${marked.parse(record._schema_summary)}</div>
    </div>`;
  }
  const parts = [];
  if (record.messages) {
    for (const msg of record.messages)
      parts.push(renderMessage(msg.role, msg.content));
  } else {
    if (record.prompt) parts.push(renderMessage("user", record.prompt));
    if (record.completion) parts.push(renderMessage("assistant", record.completion));
    if (record.rejected) parts.push(renderMessage("system", record.rejected));
  }
  if (parts.length===0) parts.push(`<pre>${JSON.stringify(record,null,2)}</pre>`);
  return `<div class="card"><div class="card-header">Record #${index+1}</div>${parts.join("")}</div>`;
}

function renderMessage(role, text) {
  if (!text) return "";
  const html = marked.parse(String(text), { breaks:true });
  if (role === "assistant") {
    return `<div class="role ${role}">${role.toUpperCase()}</div>
      <details open><summary>Response ▼</summary><div class="message markdown">${html}</div></details>`;
  }
  return `<div class="role ${role}">${role.toUpperCase()}</div>
    <div class="message markdown">${html}</div>`;
}

function nextPage(){ if(currentPage*pageSize<filtered.length){currentPage++;renderPage();}}
function prevPage(){ if(currentPage>1){currentPage--;renderPage();}}

loadRecords();
</script>
</body>
</html>
