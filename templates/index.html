<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>JSON/JSONL Viewer</title>
<link rel="stylesheet" href="/static/style.css" />
<style>
  body { background-color: #0e0f12; color: #ddd; font-family: "Inter", sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
  .topbar { display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid #222; background:#0e0f12; }
  .host-badge { font-size:12px; color:#9aa0a6; }
  .wrap { display:flex; flex:1 1 auto; min-height:0; }
  .sidebar { width: 28%; background-color: #151821; border-right: 1px solid #222; overflow-y: auto; padding: 10px; }
  .main { flex: 1; padding: 20px; overflow-y: auto; }
  .folder, .file { margin-left: 8px; cursor: pointer; line-height: 1.6em; }
  .twisty { display:inline-block; width: 1.2em; color:#7fc1ff; }
  ul { list-style: none; padding-left: 12px; }
  .crumbs { font-size: 12px; color:#9aa0a6; padding: 6px 14px; border-bottom:1px solid #111827; }
</style>
</head>
<body>
  <div class="topbar">
    <div><strong>JSON/JSONL Viewer</strong></div>
    <div class="host-badge" id="hostBadge">Loading host…</div>
  </div>

  <div class="crumbs"><span id="crumbs">Roots</span></div>

  <div class="wrap">
    <div class="sidebar">
      <h2>Files</h2>
      <div style="font-size:12px; color:#9aa0a6; margin-bottom:8px;">Showing *.json / *.jsonl</div>
      <div id="tree">Loading...</div>
    </div>
    <div class="main">
      <h2>JSONL Editor</h2>
      <p>Select a file to view records. Folders expand lazily.</p>
    </div>
  </div>

<script>
function q(name){ return new URLSearchParams(location.search).get(name); }

async function loadHost() {
  try {
    const res = await fetch('/api/host');
    const data = await res.json();
    document.getElementById('hostBadge').textContent = data.hostname + (data.uname ? ' — '+data.uname : '');
  } catch {
    document.getElementById('hostBadge').textContent = 'Host: (unknown)';
  }
}

async function apiTree(path=null) {
  const url = path ? `/api/tree?path=${encodeURIComponent(path)}&ext=json,jsonl`
                   : `/api/tree?ext=json,jsonl`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

function makeFolder(label, fullPath, loadChildren) {
  const li = document.createElement('li');
  li.className = 'folder';
  const twist = document.createElement('span');
  twist.className = 'twisty';
  twist.textContent = '▶';
  const name = document.createElement('span');
  name.textContent = label;
  name.style.color = '#7fc1ff';
  const sub = document.createElement('ul');
  sub.style.display = 'none';
  let loaded = false;

  const toggle = async () => {
    const open = sub.style.display === 'block';
    if (open) {
      sub.style.display = 'none';
      twist.textContent = '▶';
      document.getElementById('crumbs').textContent = 'Roots';
    } else {
      if (!loaded) {
        const children = await loadChildren();
        sub.innerHTML = '';
        children.forEach(n => sub.appendChild(n));
        loaded = true;
      }
      sub.style.display = 'block';
      twist.textContent = '▼';
      document.getElementById('crumbs').textContent = fullPath;
    }
  };
  twist.onclick = toggle;
  name.onclick = toggle;

  li.appendChild(twist);
  li.appendChild(name);
  li.appendChild(sub);
  return li;
}

function makeFile(label, fullPath) {
  const li = document.createElement('li');
  li.className = 'file';
  li.textContent = label;
  li.title = fullPath;
  li.onclick = () => (window.location = `/view/${fullPath.replace(/^\//,'')}`);
  return li;
}

async function buildChildren(dirPath) {
  const data = await apiTree(dirPath);
  if (!data.nodes) return [];
  return data.nodes.map(node => {
    if (node.type === 'dir') {
      return makeFolder(node.name, node.path, () => buildChildren(node.path));
    }
    return makeFile(node.name, node.path);
  });
}

async function loadTree() {
  const treeDiv = document.getElementById('tree');
  const start = q('path');

  if (!start) {
    // Show configured roots (default "/")
    const data = await apiTree(null);
    if (data.roots && data.roots.length) {
      const ul = document.createElement('ul');
      for (const r of data.roots) {
        const node = makeFolder(r, r, () => buildChildren(r));
        ul.appendChild(node);
      }
      treeDiv.innerHTML = '';
      treeDiv.appendChild(ul);
    } else {
      treeDiv.textContent = "No roots visible.";
    }
  } else {
    // Directly open provided directory
    const ul = document.createElement('ul');
    const children = await buildChildren(start);
    children.forEach(n => ul.appendChild(n));
    treeDiv.innerHTML = '';
    treeDiv.appendChild(ul);
    document.getElementById('crumbs').textContent = start;
  }
}

window.addEventListener("DOMContentLoaded", () => {
  loadHost();
  loadTree();
});
</script>
</body>
</html>

