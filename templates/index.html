<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>JSONL Viewer</title>
<style>
body {
  background-color: #0e0f12;
  color: #ddd;
  font-family: "Inter", sans-serif;
  margin: 0;
  display: flex;
  height: 100vh;
}
.sidebar {
  width: 26%;
  background-color: #151821;
  border-right: 1px solid #222;
  overflow-y: auto;
  padding: 10px;
}
.main {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}
.folder, .file {
  margin-left: 14px;
  cursor: pointer;
  line-height: 1.6em;
}
.folder > span {
  color: #7fc1ff;
}
.folder > span:hover, .file:hover {
  text-decoration: underline;
}
ul {
  list-style: none;
  padding-left: 15px;
}
</style>
</head>
<body>
  <div class="sidebar">
    <h2>Files</h2>
    <div id="tree">Loading...</div>
  </div>

  <div class="main">
    <h2>JSONL Editor</h2>
    <p>Select a file to view records.</p>
  </div>

<script>
async function loadFiles() {
  const treeDiv = document.getElementById("tree");
  treeDiv.textContent = "Loading...";

  const res = await fetch("/api/files");
  const data = await res.json();
  const files = data.files || [];

  if (!files.length) {
    treeDiv.textContent = "No JSONL files found.";
    return;
  }

  const tree = {};
  for (const file of files) {
    const parts = file.split("/");
    let current = tree;
    for (const part of parts.slice(0, -1)) {
      current[part] = current[part] || {};
      current = current[part];
    }
    current[parts[parts.length - 1]] = null;
  }

function buildNode(obj, prefix = "") {
  const ul = document.createElement("ul");
  for (const key of Object.keys(obj).sort()) {
    const li = document.createElement("li");
    const fullPath = prefix ? `${prefix}/${key}` : key;

    if (obj[key] === null) {
      li.className = "file";
      li.textContent = key;
      // ✅ proper URL and no encodeURIComponent issues
      li.onclick = () => (window.location = `/view${fullPath.startsWith("/") ? "" : "/"}${fullPath}`);
    } else {
      li.className = "folder";
      const label = document.createElement("span");
      label.textContent = "▶ " + key;

      const sub = buildNode(obj[key], fullPath);
      sub.style.display = "none";

      label.onclick = () => {
        const open = sub.style.display === "block";
        sub.style.display = open ? "none" : "block";
        label.textContent = (open ? "▶ " : "▼ ") + key;
      };

      li.appendChild(label);
      li.appendChild(sub);
    }
    ul.appendChild(li);
  }
  return ul;
}

  function findPath(node, filename, prefix = "") {
    for (const key in node) {
      const next = prefix ? `${prefix}/${key}` : key;
      if (node[key] === null && key === filename) return next;
      if (typeof node[key] === "object") {
        const found = findPath(node[key], filename, next);
        if (found) return found;
      }
    }
    return null;
  }

  treeDiv.innerHTML = "";
  treeDiv.appendChild(buildNode(tree));
}

window.addEventListener("DOMContentLoaded", loadFiles);
</script>
</body>
</html>
